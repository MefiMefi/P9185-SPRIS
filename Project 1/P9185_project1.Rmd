---
title: "P9185_project1"
author: "Fanyu, Ryan, Serena"
date: "2024-02-15"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(lme4)
library(nlme)
library(lattice)
```

```{r}
baseline.dat <- read.csv("baseline.csv")
endpoints.dat <- read.csv("endpoints.csv")
```

```{r}
endpoints.AE <-
  endpoints.dat %>% 
  select(ptid,  AE_pillA_week1:AE_gelC_week4) %>% 
  pivot_longer(
    cols = starts_with("AE_"),
    names_to = c("drug", "week"),
    names_pattern = "AE_(.*)_(week\\d+)",
    values_to = "AE"
  ) %>%
  mutate(drug = case_when(
    str_detect(drug, "pillA") ~ "Pill A",
    str_detect(drug, "gelB") ~ "Gel B",
    str_detect(drug, "gelC") ~ "Gel C"
  ),
  week = parse_number(week))

endpoints.Adhere <-
  endpoints.dat %>% 
  select(ptid, Adhere_pillA_week1:Adhere_gelC_week4) %>% 
  pivot_longer(
    cols = starts_with("Adhere_"),
    names_to = c("drug", "week"),
    names_pattern = "Adhere_(.*)_(week\\d+)",
    values_to = "Adhere"
  ) %>%
  mutate(drug = case_when(
    str_detect(drug, "pillA") ~ "Pill A",
    str_detect(drug, "gelB") ~ "Gel B",
    str_detect(drug, "gelC") ~ "Gel C"
  ),
  week = parse_number(week)) %>% 
  mutate(drug = factor(drug, levels = c("Pill A", "Gel B", "Gel C")))

endpoints.period <- 
  endpoints.dat %>% 
  select(ptid, period1:period3) %>% 
  mutate(sequence = case_when(
    period1 == "Pill A" & period2 == "Gel B" & period3 == "Gel C" ~ "ABC",
    period1 == "Pill A" & period2 == "Gel C" & period3 == "Gel B" ~ "ACB",
    period1 == "Gel B" & period2 == "Gel C" & period3 == "Pill A" ~ "BCA",
    period1 == "Gel B" & period2 == "Pill A" & period3 == "Gel C" ~ "BAC",
    period1 == "Gel C" & period2 == "Pill A" & period3 == "Gel B" ~ "CAB",
    period1 == "Gel C" & period2 == "Gel B" & period3 == "Pill A" ~ "CBA",
    TRUE ~ "Other" # This is the default case
  )) %>% 
  mutate(
    seq1 = case_when(
    sequence == "ABC" ~ 1,
    sequence == "CAB" ~ 2,
    sequence == "BCA" ~ 3,
    sequence == "BAC" ~ 4,
    sequence == "ACB" ~ 5,
    sequence == "CBA" ~ 6,
  ),
    seq2 = case_when(
      sequence == "ABC" | sequence == "BAC" ~ 0,
      sequence == "CAB" | sequence == "ACB" ~ 1,
      sequence == "BCA" | sequence == "CBA" ~ 2
    )) %>% 
  pivot_longer(
    cols = starts_with("period"),
    names_prefix = "period",
    names_to = "period",
    values_to = "drug"
  ) %>% 
  mutate(period = as.numeric(period)) %>% 
  mutate(drug = factor(drug, levels = c("Pill A", "Gel B", "Gel C")))

endpoints.lag <- 
  endpoints.period %>% 
  select(ptid, period, drug) %>% 
  group_by(ptid) %>% 
  mutate(drug_lag = lag(as.character(drug))) %>% 
  ungroup() %>% 
  replace_na(list(drug_lag = "None")) %>% 
  mutate(
    A_lag = ifelse(drug_lag == "Pill A", 1, 0),
    B_lag = ifelse(drug_lag == "Gel B", 1, 0),
    C_lag = ifelse(drug_lag == "Gel C", 1, 0)
  )

endpoints.period <- left_join(endpoints.period, endpoints.lag)

endpoints.AE <- left_join(endpoints.AE, endpoints.period)

endpoints.Adhere <- left_join(endpoints.Adhere, endpoints.period)
```

```{r}
endpoints.AE.weeksum <- 
  endpoints.AE %>% 
  select(-week) %>% 
  group_by(ptid,drug,period) %>% 
  mutate(AE_sum  = sum(AE)) %>% 
  ungroup() %>% 
  mutate(AE_ind = as.factor(ifelse(AE_sum > 0, 1, 0))) %>% 
  select(-AE) %>% 
  distinct()

endpoints.Adhere <-
  endpoints.Adhere %>% 
  mutate(total_week = period*week,
         nonAdhere = 7-Adhere)
```


```{r eda_ae}
# AE response
traj.AE <-
  endpoints.AE.weeksum %>% 
  ggplot(aes(x = period, y = AE_ind)) +
  geom_line(alpha = 0.2, aes(group = factor(ptid))) + 
  geom_point(alpha = 0.1, size = 0.8)

traj.AE
```
```{r eda_adhere}
# AE response
traj.Adhere <-
  endpoints.Adhere %>% 
  ggplot(aes(x = total_week, y = Adhere)) +
  geom_line(alpha = 0.2, aes(group = factor(ptid))) + 
  geom_point(alpha = 0.1, size = 0.8)

traj.Adhere

xyplot(Adhere ~ period, endpoints.Adhere, type=c('g','p','l'))
```


```{r model_ae}
model.AE.1 <- glmer(AE_ind ~ drug + period + seq2 + (1|ptid), data = endpoints.AE.weeksum, family = binomial)
summary(model.AE.1)

model.AE.lag <- glmer(AE_ind ~ drug + period + A_lag + B_lag + C_lag + (1|ptid), data = endpoints.AE.weeksum, family = binomial)
summary(model.AE.lag)
```


```{r model_adhere}
model.Adhere.1 <- glmer(cbind(Adhere, nonAdhere) ~ period + week + drug + A_lag + B_lag + C_lag + (1|ptid), data = endpoints.Adhere, family = binomial, nAGQ = 10)
summary(model.Adhere.1)
```

```{r eda_PK}
# 0- baseline; 1- 1st treatment; 2- 1st wash out; 3- 2nd treatment;
# 4- 2nd wash out; 5- third treatment; 6- third wash out

endpoints.PK <-
  baseline.dat %>% 
  select(ptid, bviral0:sviral6) %>% 
  mutate(
    dbvial1 = -bviral1 - bviral0,
    dsvial1 = -sviral1 - sviral0,
    dbvial2 = -bviral3 - bviral2,
    dsvial2 = -sviral3 - sviral2,
    dbvial3 = -bviral5 - bviral4,
    dsvial3 = -sviral5 - sviral4
  ) %>% 
  pivot_longer(
    cols = starts_with("d"),
    names_to = c("measure", "period"),
    names_pattern = "d(.*vial)(\\d+)",
    values_to = "dvalue"
  ) %>% 
  select(ptid, measure, period, dvalue) %>% 
  mutate(period = as.numeric(period),
         dvalue = -dvalue) 
  

traj.PK <-
  endpoints.PK %>% 
  ggplot(aes(x = period, y = dvalue, group = measure)) +
  geom_smooth(method = "lm", se = FALSE, show.legend = FALSE) +
  geom_line(alpha = 0.2, aes(group = factor(ptid))) + 
  geom_point(alpha = 0.1, size = 0.8) +
  facet_wrap(vars(measure), scales = "free_y")


traj.PK
```
```{r model_PK}
endpoints.Adhere.sum <-
  endpoints.Adhere %>% 
  select(ptid, period, week, Adhere) %>% 
  group_by(ptid, period) %>% 
  summarize(Adhere_sum  = sum(Adhere))

endpoints.PK <- left_join(endpoints.PK, endpoints.Adhere.sum)
endpoints.PK <- left_join(endpoints.PK, endpoints.AE.weeksum) %>% 
  mutate(drug = factor(drug, levels = c("Pill A", "Gel B", "Gel C")))

endpoints.PK.bvial <- endpoints.PK %>% filter(measure == "bvial")
endpoints.PK.svial <- endpoints.PK %>% filter(measure == "svial")

#model.PK.bviral <- lmer(dvalue ~  drug + period + A_lag + B_lag + C_lag + Adhere_sum + AE_ind + (1|ptid), data = endpoints.PK.bvial)
#summary(model.PK.bviral)

#model.PK.sviral <- lmer(dvalue ~  drug + period + A_lag + B_lag + C_lag + Adhere_sum + AE_ind + (1|ptid), data = endpoints.PK.svial)
#summary(model.PK.sviral)

# Combinging two measures into one model
model.PK<- lmer(dvalue ~  drug + period + A_lag + B_lag + C_lag + Adhere_sum + AE_ind + measure + (1|ptid) , data = endpoints.PK)
summary(model.PK)
# refactor (A as reference)
```
```{r}
gtsummary::tbl_regression(model.PK, tidy_fun = broom.mixed::tidy)
```
```{r}
Adhere.demo <-
  baseline.dat %>% 
  select(ptid, age, gender, race)

endpoints.Adhere.total <- 
  endpoints.Adhere.sum %>% 
  select(ptid, Adhere_sum) %>% 
  group_by(ptid) %>% 
  summarize(Adhere_total = sum(Adhere_sum))

Adhere.demo <- left_join(Adhere.demo, endpoints.Adhere.total) %>% 
  mutate(non_Adhere_total = 84 - Adhere_total)
```

```{r}
model.demo <- glm(cbind(Adhere_total, non_Adhere_total) ~ age*gender* race, data = Adhere.demo, family = binomial)

summary(model.demo)
```

