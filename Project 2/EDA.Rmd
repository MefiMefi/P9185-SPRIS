---
title: "EDA"
author: "Ryan Wei"
date: "2024-03-19"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
source(knitr::purl("./data_manipulation.Rmd", quiet=TRUE))
theme_set(theme_bw())
```


```{r}
table(data.full$treatment_group, data.full$day)
```

Outcome trajectories across different treatment groups
```{r eda-traj}
traj.plot<-
data.full %>% 
  ggplot(aes(x = day_fct, y = mem_comp)) +
  geom_line(alpha = 0.3, linewidth = 0.5, aes(group = subject_id)) +
  facet_grid(.~treatment_group) + 
  geom_smooth(color="blue", method="lm", aes(group = 1), se = FALSE) +
  ylab("Composite memory score")+
  xlab("Days of observation")
traj.plot
```


Mean response for different type of observations and treatment groups
```{r eda-traj-comp-drop}
mean.score.plot <-
data.comp %>% 
  group_by(subject_id) %>% 
  mutate(total_obs = sum(as.numeric(observed))) %>% 
  ungroup() %>% 
  mutate(type = as.factor(ifelse(total_obs == 4, "Completer", "Drop-out"))) %>% 
  group_by(type, day_fct, treatment_group) %>% 
  mutate(mean_mem_comp = mean(mem_comp,na.rm = T)) %>% 
  select(day_fct, treatment_group, type, mean_mem_comp) %>% 
  distinct() %>% 
  ungroup() %>% 
  ggplot(aes(x = day_fct, y = mean_mem_comp, group = interaction(treatment_group, type), color = treatment_group, linetype = type)) +
  geom_line(alpha = 0.8, size = 0.5) +
  scale_linetype_manual(values = c("Completer" = "solid", "Drop-out" = "dashed")) +
  labs(color = "Treatment Group", linetype = "Type") +
  ylab("Composite memory score")+
  xlab("Days of observation")+
  theme_bw()

mean.score.plot
```

Proportion of remaining in the study, i.e., survival curve
```{r}
library(survival)
library(ggsurvfit)
library(survminer)

data.surv <-
  data.comp %>% 
  select(subject_id, day_fct, observed, treatment_group) %>% 
  mutate(dropped = 1-observed) %>% 
  distinct() %>% 
  select(-observed) %>% 
  mutate(stop = as.numeric(day_fct)-1) %>% 
  group_by(subject_id) %>% 
  mutate(start = lag(stop)) %>% 
  drop_na(start)

surv_object <- Surv(data.surv$start, data.surv$stop, data.surv$dropped)

surv_fit <- survfit(surv_object ~ treatment_group, data = data.surv)

stay.plot <-
ggsurvplot(
  surv_fit,
  data = data.surv,
  xlab = "Days",
  ylab = "Proportion remaining in the study",
  ggtheme = theme_bw(),
  legend.title = "Treatment Group", # legend title
  legend.labs = c("A", "B", "C")
)

stay.plot <- stay.plot$plot + scale_x_continuous(labels = c("0", "5", "19", "90"))

stay.plot
```

